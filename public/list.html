<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diary List</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- html2canvas untuk download -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
  .diary-page {
    background: url('diary-bg.png') no-repeat center;
    background-size: cover;
    width: 380px;
    height: 600px;
    padding: 80px 40px 20px 40px; /* top right bottom left */
    font-family: "Patrick Hand", cursive;
    font-size: 18px;
    line-height: 28px;
    letter-spacing: 1px;
    white-space: pre-wrap;
    overflow: hidden;
  }
  .page-container { display: flex; transition: transform 0.5s ease; }
  </style>
</head>
<body class="min-h-screen bg-pink-50 p-6">
  <h2 class="text-2xl font-bold text-center text-pink-600">üìî Diary List</h2>
  <ul id="notesList" class="mt-4 space-y-2 max-w-3xl mx-auto"></ul>

  <div class="flex justify-center mt-6 gap-4">
    <a href="notes.html" class="bg-pink-400 hover:bg-pink-500 text-white px-6 py-2 rounded-lg">‚ûï Tambah Diary</a>
    <a href="index.html" class="bg-gray-400 hover:bg-gray-500 text-white px-6 py-2 rounded-lg">üè† Back to Home</a>
  </div>

  <!-- Modal -->
  <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg">
      <div class="relative overflow-hidden w-[380px] h-[600px]">
        <div id="pageContainer" class="page-container"></div>
      </div>
      <div class="flex justify-center gap-4 mt-4 flex-wrap">
        <button onclick="prevPage()" class="bg-pink-300 hover:bg-pink-400 text-white px-4 py-2 rounded">‚óÄ Prev</button>
        <button onclick="nextPage()" class="bg-pink-300 hover:bg-pink-400 text-white px-4 py-2 rounded">Next ‚ñ∂</button>
        <button onclick="downloadPage()" class="bg-pink-400 hover:bg-pink-500 text-white px-4 py-2 rounded">‚¨á Download</button>
        <button onclick="closeModal()" class="bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded">Close</button>
      </div>
    </div>
  </div>
  
<script type="module">
import { db } from "./firebase-init.js";
import { ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const notesRef = ref(db, "notes"); // path notes di Firebase
const list = document.getElementById("notesList");
const container = document.getElementById("pageContainer");
let currentPage = 0, totalPages = 0;

function renderNotes(notesArray) {
  list.innerHTML = "";
  notesArray.forEach((note, index) => {
    const li = document.createElement("li");
    li.className = "bg-pink-50 border p-4 rounded-lg shadow flex justify-between items-center";
    li.innerHTML = `
      <div><strong>Diary ‚Äî ${new Date(note.createdAt).toLocaleString()}</strong></div>
      <div class="space-x-2">
        <button class="px-2 py-1 bg-pink-400 hover:bg-pink-500 text-white rounded" onclick="viewDiary(${index})">View</button>
        <button class="px-2 py-1 bg-pink-300 hover:bg-pink-400 text-white rounded" onclick="editDiary(${index})">Edit</button>
        <button class="px-2 py-1 bg-pink-500 hover:bg-pink-600 text-white rounded" onclick="deleteDiary(${index})">Delete</button>
      </div>`;
    list.appendChild(li);
  });
}

let notes = [];

onValue(notesRef, (snapshot) => {
  const data = snapshot.val();
  notes = data ? Object.values(data) : [];
  renderNotes(notes);
});

// --- Modal & pagination tetap sama ---
function viewDiary(index) {
  container.innerHTML = "";
  totalPages = 0;
  currentPage = 0;

  let testDiv = document.createElement("div");
  testDiv.className = "diary-page absolute left-[-9999px] top-[-9999px] invisible";
  document.body.appendChild(testDiv);

  const text = notes[index].text.replace(/<[^>]+>/g, ""); 
  const words = text.split(/\s+/);

  let pageText = "";
  let i = 0;
  while (i < words.length) {
    pageText += words[i] + " ";
    testDiv.innerText = pageText;

    if (testDiv.scrollHeight > 600) {
      let trimmed = pageText.split(" ");
      trimmed.pop(); trimmed.pop();
      pageText = trimmed.join(" ");

      const page = document.createElement("div");
      page.className = "diary-page flex-shrink-0";
      page.innerText = pageText.trim();
      container.appendChild(page);
      totalPages++;

      pageText = words[i] + " ";
    }
    i++;
  }

  if (pageText.trim().length > 0) {
    const page = document.createElement("div");
    page.className = "diary-page flex-shrink-0";
    page.innerText = pageText.trim();
    container.appendChild(page);
    totalPages++;
  }

  document.body.removeChild(testDiv);
  showPage(0);
  document.getElementById("modal").classList.remove("hidden");
}

function editDiary(index) {
  localStorage.setItem("editIndex", index);
  window.location.href = "notes.html";
}

function deleteDiary(index) {
  alert("Untuk delete di Firebase, implementasikan dengan ref & remove(). LocalStorage delete sudah dihapus.");
}

function showPage(i) {
  container.style.transform = `translateX(-${i*380}px)`;
}
function nextPage() { if (currentPage < totalPages-1) showPage(++currentPage); }
function prevPage() { if (currentPage > 0) showPage(--currentPage); }

function closeModal() {
  document.getElementById("modal").classList.add("hidden");
}

async function downloadPage() {
  const page = container.children[currentPage];
  if (!page) return alert("No page to download");
  const canvas = await html2canvas(page, { scale: 2 });
  const link = document.createElement("a");
  link.download = `diary_${Date.now()}.png`;
  link.href = canvas.toDataURL("image/png");
  link.click();
}
</script>


</body>
</html>
